<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredi Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        .status-approved {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        .status-pending {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        .status-rejected {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
        }
        .payment-status-paid {
            color: #28a745;
        }
        .payment-status-pending {
            color: #ffc107;
        }
        .payment-status-late {
            color: #dc3545;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .btn-pay {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
        }
        .btn-pay:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-credit-card me-2"></i>
                Kredi Yönetim Sistemi
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>
                    <span id="userName">Kullanıcı</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Çıkış
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- User ID Input -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-user"></i>
                    </span>
                    <input type="number" class="form-control" id="userIdInput" placeholder="Kullanıcı ID girin" value="1">
                    <button class="btn btn-primary" onclick="loadDashboard()">
                        <i class="fas fa-search me-1"></i>
                        Yükle
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card summary-card">
                    <div class="card-body text-center">
                        <i class="fas fa-credit-card fa-2x mb-2"></i>
                        <h5 class="card-title">Toplam Kredi</h5>
                        <h3 id="totalCredits">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card summary-card">
                    <div class="card-body text-center">
                        <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                        <h5 class="card-title">Toplam Tutar</h5>
                        <h3 id="totalAmount">₺0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card summary-card">
                    <div class="card-body text-center">
                        <i class="fas fa-calendar-check fa-2x mb-2"></i>
                        <h5 class="card-title">Ödenen Taksit</h5>
                        <h3 id="paidInstallments">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card summary-card">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h5 class="card-title">Geciken Ödeme</h5>
                        <h3 id="latePayments">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="credits-tab" data-bs-toggle="tab" data-bs-target="#credits" type="button" role="tab">
                    <i class="fas fa-credit-card me-1"></i>
                    Kredilerim
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
                    <i class="fas fa-money-bill-wave me-1"></i>
                    Ödemelerim
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                    <i class="fas fa-clock me-1"></i>
                    Bekleyen Ödemeler
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="new-application-tab" data-bs-toggle="tab" data-bs-target="#new-application" type="button" role="tab">
                    <i class="fas fa-plus-circle me-1"></i>
                    Yeni Başvuru
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="dashboardTabContent">
            <!-- Credits Tab -->
            <div class="tab-pane fade show active" id="credits" role="tabpanel">
                <div class="row" id="creditsContainer">
                    <!-- Credits will be loaded here -->
                </div>
            </div>

            <!-- Payments Tab -->
            <div class="tab-pane fade" id="payments" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Taksit No</th>
                                <th>Vade Tarihi</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>Ödeme Tarihi</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <!-- Payments will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pending Payments Tab -->
            <div class="tab-pane fade" id="pending" role="tabpanel">
                <div class="row" id="pendingPaymentsContainer">
                    <!-- Pending payments will be loaded here -->
                </div>
            </div>

            <!-- New Application Tab -->
            <div class="tab-pane fade" id="new-application" role="tabpanel">
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <div class="card dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-credit-card me-2"></i>
                                    Yeni Kredi Başvurusu
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="creditApplicationForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Kredi Türü</label>
                                            <select class="form-select" id="creditTypeSelect" required>
                                                <option value="">Kredi türü seçiniz</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Talep Tutarı (TL)</label>
                                            <input type="number" class="form-control" id="requestedAmount" placeholder="25000" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Vade (Ay)</label>
                                            <input type="number" class="form-control" id="requestedTerm" placeholder="12" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Aylık Gelir (TL)</label>
                                            <input type="number" class="form-control" id="monthlyIncome" placeholder="8000" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Başvuru Amacı</label>
                                        <textarea class="form-control" id="purpose" rows="3" placeholder="Kredi başvuru amacınızı açıklayın..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isUrgent">
                                            <label class="form-check-label" for="isUrgent">
                                                Acil başvuru
                                            </label>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle me-2"></i>Gerekli Belgeler:</h6>
                                        <ul class="mb-0">
                                            <li>Kimlik fotokopisi</li>
                                            <li>Maaş bordrosu (son 3 ay)</li>
                                            <li>Adres belgesi</li>
                                            <li>Vergi levhası (varsa)</li>
                                        </ul>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-pay">
                                            <i class="fas fa-paper-plane me-2"></i>
                                            Başvuru Gönder
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ödeme Yap</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Ödeme Yöntemi</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="">Seçiniz</option>
                                <option value="BANK_TRANSFER">Banka Transferi</option>
                                <option value="CREDIT_CARD">Kredi Kartı</option>
                                <option value="DEBIT_CARD">Banka Kartı</option>
                                <option value="CASH">Nakit</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Not (Opsiyonel)</label>
                            <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <strong>Ödeme Detayları:</strong>
                            <div id="paymentDetails"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="submitPayment()">
                        <i class="fas fa-credit-card me-1"></i>
                        Ödeme Yap
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPaymentId = null;
        const API_BASE_URL = 'http://localhost:3000';

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (checkAuth()) {
                loadDashboard();
                loadCreditTypes();
            }
        });

        async function loadDashboard() {
            const token = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user'));
            
            if (!token || !user) {
                alert('Lütfen önce giriş yapın');
                window.location.href = 'login.html';
                return;
            }

            const userId = user.id; // JWT'den gelen kullanıcı ID'si

            try {
                // Load user info
                const userResponse = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!userResponse.ok) {
                    throw new Error(`Kullanıcı bilgileri yüklenemedi: ${userResponse.status}`);
                }
                const user = await userResponse.json();
                document.getElementById('userName').textContent = `${user.firstName} ${user.lastName}`;

                // Load credit summary
                const creditSummaryResponse = await fetch(`${API_BASE_URL}/users/${userId}/credit-summary`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!creditSummaryResponse.ok) {
                    throw new Error(`Kredi özeti yüklenemedi: ${creditSummaryResponse.status}`);
                }
                const creditSummary = await creditSummaryResponse.json();
                
                document.getElementById('totalCredits').textContent = creditSummary.totalCredits;
                document.getElementById('totalAmount').textContent = `₺${creditSummary.totalAmount.toLocaleString()}`;

                // Load payment summary
                const paymentSummaryResponse = await fetch(`${API_BASE_URL}/payments/user/${userId}/summary`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!paymentSummaryResponse.ok) {
                    throw new Error(`Ödeme özeti yüklenemedi: ${paymentSummaryResponse.status}`);
                }
                const paymentSummary = await paymentSummaryResponse.json();
                
                document.getElementById('paidInstallments').textContent = paymentSummary.paidPayments;
                document.getElementById('latePayments').textContent = paymentSummary.latePayments;

                // Load credits
                await loadCredits(userId);
                
                // Load payments
                await loadPayments(userId);
                
                // Load pending payments
                await loadPendingPayments(userId);

            } catch (error) {
                console.error('Dashboard yüklenirken hata:', error);
                alert(`Dashboard yüklenirken hata oluştu: ${error.message}`);
            }
        }

        async function loadCreditTypes() {
            try {
                const response = await fetch(`${API_BASE_URL}/credit-types`);
                if (!response.ok) {
                    throw new Error(`Kredi türleri yüklenemedi: ${response.status}`);
                }
                const creditTypes = await response.json();
                
                const select = document.getElementById('creditTypeSelect');
                select.innerHTML = '<option value="">Kredi türü seçiniz</option>';
                
                creditTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = `${type.name} (${type.interestRate}% aylık)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Kredi türleri yüklenirken hata:', error);
                const select = document.getElementById('creditTypeSelect');
                select.innerHTML = '<option value="">Kredi türleri yüklenemedi</option>';
            }
        }

        async function loadCredits(userId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/users/${userId}/credits`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Krediler yüklenemedi: ${response.status}`);
                }
                const data = await response.json();
                
                const container = document.getElementById('creditsContainer');
                container.innerHTML = '';

                // Backend direkt array döndürüyor, frontend { credits: [...] } bekliyor
                const credits = Array.isArray(data) ? data : (data.credits || []);
                
                if (credits && credits.length > 0) {
                    credits.forEach(credit => {
                        const statusClass = getStatusClass(credit.status);
                        const statusText = getStatusText(credit.status);
                        
                        const creditCard = `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card dashboard-card ${statusClass}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title">${credit.creditType?.name || 'Kredi'}</h6>
                                            <span class="badge bg-${getStatusBadge(credit.status)}">${statusText}</span>
                                        </div>
                                        <p class="card-text">
                                            <strong>Başvuru No:</strong> ${credit.applicationNumber || 'N/A'}<br>
                                            <strong>Tutar:</strong> ₺${credit.requestedAmount?.toLocaleString() || 0}<br>
                                            <strong>Vade:</strong> ${credit.requestedTerm || 0} ay<br>
                                            <strong>Başvuru Tarihi:</strong> ${new Date(credit.createdAt).toLocaleDateString('tr-TR')}
                                        </p>
                                        ${credit.status === 'APPROVED' ? `
                                            <button class="btn btn-pay btn-sm" onclick="viewPayments(${credit.id})">
                                                <i class="fas fa-eye me-1"></i>
                                                Ödemeleri Gör
                                            </button>
                                        ` : credit.status === 'PENDING' ? `
                                            <button class="btn btn-warning btn-sm" disabled>
                                                <i class="fas fa-clock me-1"></i>
                                                İncelemede
                                            </button>
                                        ` : credit.status === 'REJECTED' ? `
                                            <button class="btn btn-danger btn-sm" disabled>
                                                <i class="fas fa-times me-1"></i>
                                                Reddedildi
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += creditCard;
                    });
                } else {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                Henüz kredi başvurunuz bulunmamaktadır.
                                <br><br>
                                <button class="btn btn-pay" onclick="showNewApplicationTab()">
                                    <i class="fas fa-plus-circle me-1"></i>
                                    Yeni Başvuru Yap
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Krediler yüklenirken hata:', error);
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Krediler yüklenirken hata oluştu: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        async function loadPayments(userId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/payments/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Ödemeler yüklenemedi: ${response.status}`);
                }
                const payments = await response.json();
                
                const tbody = document.getElementById('paymentsTableBody');
                tbody.innerHTML = '';

                if (payments && payments.length > 0) {
                    payments.forEach(payment => {
                        const statusClass = getPaymentStatusClass(payment.status);
                        const statusText = getPaymentStatusText(payment.status);
                        
                        const row = `
                            <tr>
                                <td>${payment.installmentNumber}</td>
                                <td>${new Date(payment.dueDate).toLocaleDateString('tr-TR')}</td>
                                <td>₺${payment.amount?.toLocaleString() || 0}</td>
                                <td><span class="${statusClass}">${statusText}</span></td>
                                <td>${payment.paidAt ? new Date(payment.paidAt).toLocaleDateString('tr-TR') : '-'}</td>
                                <td>
                                    ${payment.status?.toLowerCase() === 'pending' || payment.status?.toLowerCase() === 'late' ? `
                                        <button class="btn btn-pay btn-sm" onclick="openPaymentModal(${payment.id}, ${payment.amount})">
                                            <i class="fas fa-credit-card me-1"></i>
                                            Öde
                                        </button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                Ödeme bulunamadı veya henüz ödeme planı oluştu
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Ödemeler yüklenirken hata:', error);
                const tbody = document.getElementById('paymentsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Ödemeler yüklenirken hata oluştu: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        async function loadPendingPayments(userId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/payments/user/${userId}/pending`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Bekleyen ödemeler yüklenemedi: ${response.status}`);
                }
                const payments = await response.json();
                
                const container = document.getElementById('pendingPaymentsContainer');
                container.innerHTML = '';

                if (payments && payments.length > 0) {
                    payments.forEach(payment => {
                        const paymentCard = `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card dashboard-card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-calendar me-1"></i>
                                            Taksit ${payment.installmentNumber}
                                        </h6>
                                        <p class="card-text">
                                            <strong>Vade:</strong> ${new Date(payment.dueDate).toLocaleDateString('tr-TR')}<br>
                                            <strong>Tutar:</strong> ₺${payment.amount?.toLocaleString() || 0}<br>
                                            <strong>Kredi:</strong> ${payment.creditApplication?.id || 'N/A'}
                                        </p>
                                        <button class="btn btn-pay btn-sm w-100" onclick="openPaymentModal(${payment.id}, ${payment.amount})">
                                            <i class="fas fa-credit-card me-1"></i>
                                            Ödeme Yap
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += paymentCard;
                    });
                } else {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-success text-center">
                                <i class="fas fa-check-circle me-2"></i>
                                Bekleyen ödemeniz bulunmamaktadır.
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Bekleyen ödemeler yüklenirken hata:', error);
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Bekleyen ödemeler yüklenirken hata oluştu: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        function openPaymentModal(paymentId, amount) {
            currentPaymentId = paymentId;
            document.getElementById('paymentDetails').innerHTML = `
                <strong>Taksit Tutarı:</strong> ₺${amount?.toLocaleString() || 0}<br>
                <strong>Ödeme ID:</strong> ${paymentId}
            `;
            document.getElementById('paymentMethod').value = '';
            document.getElementById('paymentNotes').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        async function submitPayment() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!paymentMethod) {
                alert('Lütfen ödeme yöntemi seçin');
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const user = JSON.parse(localStorage.getItem('user'));
                const userId = user.id;
                const response = await fetch(`${API_BASE_URL}/payments/user/${userId}/pay/${currentPaymentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        paymentMethod: paymentMethod,
                        notes: notes
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Ödeme başarıyla tamamlandı!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                    modal.hide();
                    
                    // Reload data
                    await loadDashboard();
                } else {
                    const error = await response.json();
                    alert(`Ödeme hatası: ${error.message}`);
                }
            } catch (error) {
                console.error('Ödeme yapılırken hata:', error);
                alert(`Ödeme yapılırken hata oluştu: ${error.message}`);
            }
        }

        function viewPayments(creditApplicationId) {
            // Switch to payments tab and filter by credit application
            const paymentsTab = document.getElementById('payments-tab');
            const tab = new bootstrap.Tab(paymentsTab);
            tab.show();
            
            // You can implement filtering by credit application here
            alert(`Kredi ${creditApplicationId} ödemeleri görüntüleniyor`);
        }

        function getStatusClass(status) {
            switch (status) {
                case 'APPROVED': return 'status-approved';
                case 'PENDING': return 'status-pending';
                case 'REJECTED': return 'status-rejected';
                case 'CANCELLED': return 'status-rejected';
                default: return '';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'APPROVED': return 'Onaylandı';
                case 'PENDING': return 'Beklemede';
                case 'REJECTED': return 'Reddedildi';
                case 'CANCELLED': return 'İptal Edildi';
                default: return status;
            }
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'APPROVED': return 'success';
                case 'PENDING': return 'warning';
                case 'REJECTED': return 'danger';
                case 'CANCELLED': return 'secondary';
                default: return 'secondary';
            }
        }

        function getPaymentStatusClass(status) {
            switch (status?.toUpperCase()) {
                case 'PAID': return 'payment-status-paid';
                case 'PENDING': return 'payment-status-pending';
                case 'LATE': return 'payment-status-late';
                case 'DEFAULTED': return 'payment-status-late';
                default: return '';
            }
        }

        function getPaymentStatusText(status) {
            switch (status?.toUpperCase()) {
                case 'PAID': return 'Ödendi';
                case 'PENDING': return 'Beklemede';
                case 'LATE': return 'Gecikmiş';
                case 'DEFAULTED': return 'Temerrüt';
                default: return status;
            }
        }

        // Authentication kontrolü
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                alert('Lütfen önce giriş yapın');
                window.location.href = 'login.html';
                return false;
            }
            
            try {
                const userData = JSON.parse(user);
                document.getElementById('userName').textContent = `${userData.firstName} ${userData.lastName}`;
                // Kullanıcı ID input'unu gizle ve sadece JWT'den gelen ID kullan
                document.getElementById('userIdInput').value = userData.id;
                document.getElementById('userIdInput').style.display = 'none';
                document.querySelector('.input-group').style.display = 'none';
                return true;
            } catch (error) {
                console.error('User data parse error:', error);
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        function showNewApplicationTab() {
            const newApplicationTab = document.getElementById('new-application-tab');
            const tab = new bootstrap.Tab(newApplicationTab);
            tab.show();
        }

        // Credit application form submission
        document.getElementById('creditApplicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user'));
            const userId = user.id;
            
            if (!token || !user) {
                alert('Lütfen önce giriş yapın');
                window.location.href = 'login.html';
                return;
            }

            const creditTypeId = document.getElementById('creditTypeSelect').value;
            const requestedAmount = parseFloat(document.getElementById('requestedAmount').value);
            const requestedTerm = parseInt(document.getElementById('requestedTerm').value);
            const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
            const purpose = document.getElementById('purpose').value;
            const isUrgent = document.getElementById('isUrgent').checked;

            if (!creditTypeId || !requestedAmount || !requestedTerm || !monthlyIncome) {
                alert('Lütfen tüm zorunlu alanları doldurun');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/credit-applications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        creditTypeId: parseInt(creditTypeId),
                        requestedAmount: requestedAmount,
                        requestedTerm: requestedTerm,
                        monthlyIncome: monthlyIncome,
                        documents: {
                            kimlik: 'uploaded',
                            bordro: 'uploaded',
                            adres: 'uploaded'
                        },
                        additionalInfo: {
                            purpose: purpose,
                            urgency: isUrgent ? 'urgent' : 'normal'
                        },
                        isUrgent: isUrgent
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Kredi başvurunuz başarıyla gönderildi! Başvuru numaranız: ' + result.applicationNumber);
                    
                    // Reset form
                    document.getElementById('creditApplicationForm').reset();
                    
                    // Switch to credits tab to see the new application
                    const creditsTab = document.getElementById('credits-tab');
                    const tab = new bootstrap.Tab(creditsTab);
                    tab.show();
                    
                    // Reload dashboard
                    await loadDashboard();
                } else {
                    const error = await response.json();
                    alert(`Başvuru hatası: ${error.message}`);
                }
            } catch (error) {
                console.error('Başvuru gönderilirken hata:', error);
                alert(`Başvuru gönderilirken hata oluştu: ${error.message}`);
            }
        });
    </script>
</body>
</html> 